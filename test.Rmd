---
title: "Test"
author: "RyoÂ®, Eng Lian Hu"
date: "October 25, 2015"
output: html_document
---


Testing output of the coding.

```{r load-packages}
## ,include=FALSE}
## Setup Options, Loading Required Libraries and Preparing Environment
## Setup `knitr` options and loading the required libraries.

## Setting to omit all warnings
options(warn=-1)

## Loading the packages
if(!suppressPackageStartupMessages(require('devtools'))){
  install.packages('devtools')}
if(!suppressPackageStartupMessages(require('BBmisc'))){
  install.packages('BBmisc')}
if(!suppressPackageStartupMessages(require('BiocParallel'))){
  devtools::install_github('Bioconductor/BiocParallel')}

## http://www.r-bloggers.com/new-package-dplyrr-utilities-for-comfortable-use-of-dplyr-with-databases
## direct connect to database (if any)
#' @if(!'dplyrr' %in% installed.packages()){
#' @  devtools::install_github("hoxo-m/dplyrr")}
#' @install.packages('nycflights13')
#' @library(c('dplyrr','nycflights13'))

suppressPackageStartupMessages(library('BBmisc'))
pkgs <- c('devtools','zoo','chron','stringr','stringi','reshape','reshape2','data.table','sparkline','DT','plyr','dplyr','magrittr','foreach','manipulate','ggplot2','ggthemes','proto','extrafont','directlabels','PerformanceAnalytics','plotly','doParallel','rvest','highlightHTML','knitr','rmarkdown','scales','lubridate','tidyr','whisker','gtable','grid','gridExtra','pander','arules','arulesViz','googleVis')
#'@ c('memoise','RStudioAMI','parallel','BiocParallel','RSelenium','doMC','editR') #load if needed
suppressAll(lib(pkgs)); rm(pkgs)
```

```{r setting}
## Creating a parallel computing Cluster and support functions.

## Preparing the parallel cluster using the cores
doParallel::registerDoParallel(cores = 16)
#' @BiocParallel::register(MulticoreParam(workers=8))

## knitr configuration
opts_knit$set(progress=FALSE)
opts_chunk$set(echo=TRUE, message=FALSE, tidy=TRUE, comment=NA, fig.path="figure/", fig.keep="high", fig.width=10, fig.height=6, fig.align="center")

## Table width setting
panderOptions('table.split.table', Inf)

## Setup plotly API
Sys.setenv('plotly_username'='englianhu')
Sys.setenv('plotly_api_key'='xxxxxxxxx')

# Set the googleVis options first to change the behaviour of plot.gvis, so that only the chart component of the HTML file is written into the output file.
op <- options(gvis.plot.tag='chart')
```


### 2.1 Collect and Reprocess the Dataset

  I collect the dataset of World Wide soccer matches from year 2011 until 2015 from a British betting consultancy named firm A. All bets placed by display on HK currency, and the odds price also measure based on Hong Kong price.
  
  I tried to apply `RSelenium` on [**RStudio Server Centos7**](http://rstudio.scibrokes.com) to scrape the data from livescore website includes the odds price but the binary [phantomjs](https://github.com/ariya/phantomjs/issues/12948#issuecomment-131267076) is not available for Linux, and I also not familiar with the installation of `Java` as well as setting of the path for `rJava`. Kindly refer to [Natural Language Analysis](http://rpubs.com/englianhu/natural-language-analysis) for more information about the teams name matching.

```{r read-data-summary-table, results='asis'}
## Read the datasets
## Refer to **Testing efficiency of coding.Rmd** at chunk `get-data-summary-table-2.1`
source(paste0(getwd(),'/function/readfirmDatasets.R'))
source(paste0(getwd(),'/function/arrfirmDatasets.R'))
years <- seq(2011,2015)

## Here I take the majority leagues setting profile which are "league-10-12"
## fMYPriceB = Back with vigorish price; fMYPriceL = Lay with vigorish price
## Here we term as Fair Odds
lProfile <- c(AH=0.10,OU=0.12)

mbase <- readfirmDatasets(years=years) %>% arrfirmDatasets(., lProfile=lProfile)

#'@ pander(head(mbase$datasets)) # exactly same layout with kable(x)
#'@ kable(head(mbase$datasets)) ## example of the dataset in the research paper

#'@ mbase$datasets %>% datatable(.,caption="Table 2.1.1 : Firm A Staking Data",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

  Please refer to [Natural Language Analysis](http://rpubs.com/englianhu/natural-language-analysis) to see the firm A staking sample dataset.

```{r scrap-data, results='asis'}
## Scrape the leagues and also overrounds which provides by a sportsbookmaker named Firm B
#'@ lnk <- 'http://data.nowgoal.com/history/handicap.htm'
## Above website provides odds price history but sendkeyElements cannot work in RSelenium, will follow-up
## https://github.com/ropensci/RSelenium/issues/55
## Therefore scrape spbo link to know the league of matches

## Besides, need to scrap the final-scores / half-time scores / result of soccer matches
dateID <- sort(unique(mbase$datasets$Date)); spboDate <- gsub('-','',dateID)
#'@ lnk <- paste0('http://www8.spbo.com/history.plex?day=',spboDate,'&l=en')

## Due to the scrapSPBO function scrapped unmatched data, example lnk[827],
##  therefore I rewrite the function as scrapSPBO2
#'@ source(paste0(getwd(),'/function/scrapSPBO2.R'))
#'@ scrapSPBO2(lnk=lnk, dateID=dateID, path='livescore', parallel=TRUE)

## Load the scraped spbo livescore datasets.
source(paste0(getwd(),'/function/readSPBO2.R'))
spboData <- readSPBO2(dateID=dateID, parallel=FALSE)

## Apply stringdist() to 'exactly matching' and 'approximate matching' team names
#'@ method <- c('osa','lv','dl','hamming','lcs','qgram','cosine','jaccard','jw','soundex')
#'@ source(paste0(getwd(),'/function/arrTeamID.R'))
#'@ tmID <- arrTeamID(mbase, spboData, parallel=FALSE)
tmIDdata <- read.csv(paste0(getwd(),'/datasets/teamID.csv'), header=TRUE, sep=',') %>% mutate_each(funs(as.character)) %>% tbl_df %>% filter(spbo!='Kuban Krasnodar')
spboData %<>% filter((Home %in% tmIDdata$spbo)|(Away %in% tmIDdata$spbo))
```
  

## 3. Analyse the Staking Model


### 3.1 Analyse the Annual Stakes

  Before we start analyse the staking model, we are firstly see the monthly Stakes and Profit & Lose of the Agency A.

```{r data-month-summary-plots, results='asis'}
## Before we start analyse the staking model, we are firstly see the monthly Stakes and Profit & Lose of the Agency A
## the stakes amount display as $1 = $10,000
#'@ zoo::as.yearmon(mbase$Date,'%b')
#'@ chron::cut_date()
m <- ddply(data.frame(Month=as.yearmon(mbase$datasets$Date,'%b'),mbase$datasets), .(Sess, Month), summarise, Stakes=sum(Stakes)/10000, PL=sum(PL)/10000)
melted <- melt(m, id.vars=c('Sess','Month')) %>% tbl_df
#'@ melted$Month2 <- format(melted$Month,'%b')

## http://help.plot.ly/make-a-3D-surface-plot
## Will doing research on 3D graph some other days.
gvis.options <- list(hAxis="{title:'Month'}", vAxis="{title:'Stakes(in \'0000)'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar="Month", yvar=c("value"), data=melted, options=gvis.options)
plot(line.gvis)
print(line.gvis,tag='chart')
#'@ plots <- suppressWarnings(dlply(melted, .(Sess), function(mb) ggplot(x=factor(Month), y=value, fill=variable, data=mb, geom='bar', stat='identity', position='dodge', color=variable) + ylab("HKD (in '0000)") + theme_pander(base_family='Verdana') + scale_fill_pander() + ggtitle(paste('Monthly Summary ',min(mb$Month),'-',max(mb$Month)))))

#'@ rm(melted, m)
#'@ do.call(grid.arrange, plots)
```

```{r}
CC <- gvisComboChart(melted, xvar='Month',
          yvar=c(value),
          options=list(seriesType='bars',
                       width=450, height=300,
                       title='Monthly Summary',
                       series='{0: {type:"line"}}'))
plot(CC)
```

*graph 3.1.1*

```{r, results='asis'}
## Set options back to original options
options(op)
```

